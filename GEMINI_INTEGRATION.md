# ğŸ¤– IntegraciÃ³n con Google Gemini AI

## DescripciÃ³n

Esta funcionalidad permite que el sistema analice automÃ¡ticamente las noticias obtenidas de medios periodÃ­sticos y genere incidentes verificados cuando detecta:
- **UbicaciÃ³n especÃ­fica**: Calle, esquina o barrio mencionado en la noticia
- **Tipo de delito**: Homicidio, rapiÃ±a, hurto, copamiento, etc.

Los incidentes generados automÃ¡ticamente aparecen en el mapa con estado `auto_verified` y estÃ¡n vinculados a las noticias que los originaron.

---

## âœ… Estado Actual

**ConfiguraciÃ³n completada exitosamente:**
- âœ… API key configurada y funcionando
- âœ… Modelo: `gemini-2.5-flash` (rÃ¡pido y econÃ³mico)
- âœ… IntegraciÃ³n con ingesta de noticias
- âœ… Sistema de cachÃ© (24 horas)
- âœ… Manejo de duplicados (agrega como evidencia)
- âœ… Frontend actualizado con badges y enlaces a fuentes

---

## ğŸ”§ ConfiguraciÃ³n

### Variables de entorno (`.env`)

```bash
# Google Gemini API
GEMINI_API_KEY=AIzaSyAzHR2nbDUl9PN82ffd9bnxmSMLhNbQEYc
GEMINI_MODEL=gemini-2.5-flash
```

**Nota:** Si necesitas obtener una nueva API key:
1. Ve a: https://aistudio.google.com/app/apikey
2. Crea una nueva API key (es gratuita con lÃ­mites generosos)
3. Reemplaza el valor en `.env`

---

## ğŸš€ Funcionamiento

### Flujo de anÃ¡lisis automÃ¡tico

```
RSS Feed â†’ Parse ArtÃ­culo â†’ Guardar Noticia en BD
                                    â†“
                          Gemini analiza contenido
                                    â†“
                    Â¿UbicaciÃ³n especÃ­fica + Delito?
                                    â†“
                                   SÃ
                                    â†“
                Buscar incidente similar (< 200m, Ãºltimos 7 dÃ­as)
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                               â†“
            Ya existe similar                No existe similar
                    â†“                               â†“
        Agregar noticia como evidencia    Crear nuevo incidente
        (actualiza sourceNews[])           status: auto_verified
                    â†“                               â†“
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
                    Emitir evento Socket.IO â†’ Actualizar mapa
```

### Criterios de detecciÃ³n

Gemini **SOLO** crea incidentes cuando:
1. **Hay ubicaciÃ³n especÃ­fica**:
   - âœ… "26 de Marzo y Benito Blanco"
   - âœ… "Pocitos"
   - âœ… "Ciudad Vieja"
   - âŒ "Montevideo" (demasiado genÃ©rico)
   - âŒ "Uruguay" (demasiado genÃ©rico)

2. **Hay un delito identificable**:
   - homicidio
   - rapiÃ±a
   - hurto
   - copamiento
   - violencia_domÃ©stica
   - narcotrÃ¡fico
   - otro

3. **Tiene contexto suficiente** para determinar severidad (1-5)

---

## ğŸ“Š Campos del incidente auto-generado

```javascript
{
  type: "rapiÃ±a",                    // Tipo de delito detectado
  severity: 3,                        // Gravedad (1-5)
  location: {                         // Coordenadas geocodificadas
    type: "Point",
    coordinates: [-56.123, -34.456]
  },
  locationType: "exact",              // "exact" o "approximate"
  description: "...",                 // DescripciÃ³n generada por Gemini
  reporterUid: "system",              // Identificador del sistema
  reporterReputation: 0,              // No aplica para sistema
  autoGenerated: true,                // Flag de auto-generaciÃ³n
  sourceNews: [{                      // Noticias vinculadas
    newsId: ObjectId("..."),
    title: "RapiÃ±a en Pocitos...",
    url: "https://...",
    source: "El Observador",
    addedAt: Date
  }],
  status: "auto_verified",            // Verificado automÃ¡ticamente
  validationScore: 1.0,               // Score mÃ¡ximo
  validationCount: 1                  // Validado por el sistema
}
```

---

## ğŸ¯ Casos de uso

### 1. Nueva noticia con incidente
```
Noticia: "RapiÃ±a en Pocitos: dos delincuentes asaltaron un comercio
         en la esquina de 26 de Marzo y Benito Blanco"

â†’ Gemini detecta:
  - UbicaciÃ³n: "26 de Marzo y Benito Blanco, Pocitos"
  - Tipo: rapiÃ±a
  - Severidad: 3

â†’ Sistema geocodifica y crea incidente auto_verified
â†’ Aparece en el mapa con badge azul "Auto-verificado"
```

### 2. Noticia sobre incidente existente
```
DÃ­a 1: Noticia "RapiÃ±a en Pocitos..." â†’ Crea incidente A

DÃ­a 2: Noticia "Nuevos datos sobre rapiÃ±a en Pocitos..."
       â†’ Detecta incidente similar (< 200m)
       â†’ Agrega noticia a sourceNews[] del incidente A
       â†’ NO crea incidente duplicado
```

### 3. Noticia sin ubicaciÃ³n especÃ­fica
```
Noticia: "Aumentan las rapiÃ±as en Montevideo"

â†’ Gemini detecta: Solo "Montevideo" (genÃ©rico)
â†’ NO crea incidente (ubicaciÃ³n no especÃ­fica)
â†’ Solo guarda la noticia en BD
```

---

## ğŸ’¾ CachÃ©

El sistema usa cachÃ© en MongoDB con TTL de 24 horas para:
- **Reducir costos**: No reanalizar la misma noticia
- **Mejorar velocidad**: Respuesta instantÃ¡nea de cache hit
- **Optimizar API calls**: Gemini tiene lÃ­mites de rate

Modelo de cachÃ©:
```javascript
{
  cacheKey: "gemini:incident:https://noticia-url",
  data: { /* resultado del anÃ¡lisis */ },
  expiresAt: Date (24 horas)
}
```

---

## ğŸ¨ Frontend

### En el mapa (`map.js`)

**Badge de estado auto-verificado:**
```javascript
statusColors['auto_verified'] = '#2196f3'  // Azul
statusLabels['auto_verified'] = 'Auto-verificado'
```

**SecciÃ³n de fuentes de noticias:**
```html
ğŸ“° Fuentes verificadas:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ El Observador                  â”‚
â”‚ RapiÃ±a en Pocitos...           â”‚
â”‚ Ver noticia completa â†’         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Restricciones:**
- âœ… Invitados ven incidentes `auto_verified`
- âŒ Usuarios NO pueden validar incidentes `auto_verified`
- â„¹ï¸ Muestra mensaje: "Verificado automÃ¡ticamente desde fuentes confiables"

---

## ğŸ“ˆ Logs y Monitoreo

### Logs importantes

```javascript
// Inicio de anÃ¡lisis
logger.info('Analyzing news with Gemini for incident analysis', {
  newsId: '...',
  url: '...'
});

// Incidente detectado
logger.info('Gemini detected incident in news', {
  newsId: '...',
  incidentType: 'rapiÃ±a',
  locationName: 'Pocitos',
  severity: 3
});

// Incidente creado
logger.info('Created new auto-verified incident from news', {
  incidentId: '...',
  newsId: '...',
  type: 'rapiÃ±a'
});

// Evidencia agregada
logger.info('Added news as evidence to existing incident', {
  incidentId: '...',
  newsId: '...',
  totalSourceNews: 3
});
```

### Errores no fatales

Si Gemini falla, la ingesta de noticias continÃºa normalmente:

```javascript
logger.error('Gemini analysis failed (non-fatal)', {
  newsId: '...',
  error: 'Rate limit exceeded'
});
```

---

## ğŸ” Testing

Para probar la integraciÃ³n manualmente, puedes ejecutar la ingesta de noticias desde el panel de admin:

```bash
# En el navegador
https://localhost:3000/admin

â†’ Panel de Noticias
â†’ BotÃ³n "Ejecutar ingesta manual"
â†’ Ver logs en consola del servidor
```

---

## ğŸ’° Costos y LÃ­mites

**Google Gemini API (Free Tier):**
- 15 requests/minuto
- 1500 requests/dÃ­a
- 1 millÃ³n tokens/dÃ­a

**Consumo estimado:**
- ~1 request por noticia analizada
- ~500-1000 tokens por anÃ¡lisis
- Con ingesta cada 15 min (4/hora) â†’ ~100 requests/dÃ­a
- **Muy por debajo del lÃ­mite gratuito**

**Optimizaciones implementadas:**
- âœ… CachÃ© de 24 horas (reduce requests)
- âœ… Solo analiza noticias nuevas
- âœ… Skip si API key no estÃ¡ configurada

---

## ğŸ› ï¸ Troubleshooting

### Error: "GEMINI_API_KEY not configured"
**Causa:** Falta la API key en `.env`
**SoluciÃ³n:** Agregar `GEMINI_API_KEY=...` al archivo `.env` y reiniciar servidor

### Error: "Model not found"
**Causa:** Nombre de modelo incorrecto
**SoluciÃ³n:** Usar `gemini-2.5-flash` (mÃ¡s reciente y estable)

### Error: "403 Forbidden"
**Causa:** API key invÃ¡lida o restricciones
**SoluciÃ³n:**
1. Verificar API key en https://aistudio.google.com/app/apikey
2. Asegurarse de usar API key de Google AI Studio (NO Google Cloud)
3. Verificar que no haya espacios o caracteres extra

### Error: "429 Too Many Requests"
**Causa:** Excediste el rate limit
**SoluciÃ³n:** Esperar 1 minuto. El sistema usa cachÃ© para minimizar esto.

### No se crean incidentes
**Posibles causas:**
1. Las noticias no mencionan ubicaciÃ³n especÃ­fica â†’ **Esperado**
2. Gemini no detecta delito claro â†’ **Esperado**
3. La API key estÃ¡ mal configurada â†’ Verificar logs
4. El servidor no se reiniciÃ³ despuÃ©s de agregar la key â†’ Reiniciar

---

## ğŸ“ Archivos modificados

```
src/services/geminiService.js      â† Servicio de anÃ¡lisis con Gemini
src/models/Incident.js             â† Campos: autoGenerated, sourceNews, status
src/jobs/newsIngestion.js          â† IntegraciÃ³n post-noticia
src/routes/incidents.js            â† Filtros y validaciones
public/js/map.js                   â† UI para incidentes auto-verificados
.env                               â† Variables GEMINI_API_KEY y GEMINI_MODEL
```

---

## ğŸ¯ PrÃ³ximos pasos opcionales

Posibles mejoras futuras:
1. **Dashboard de anÃ¡lisis**: Ver estadÃ­sticas de detecciÃ³n de Gemini
2. **Ajuste de severidad**: Permitir a admins corregir la severidad
3. **Multi-idioma**: Analizar noticias en espaÃ±ol/inglÃ©s/portuguÃ©s
4. **AnÃ¡lisis de tendencias**: Usar Gemini para detectar patrones temporales
5. **OCR de imÃ¡genes**: Analizar fotos de noticias con Gemini Vision

---

## ğŸ“š Referencias

- **Google AI Studio**: https://aistudio.google.com/
- **Gemini API Docs**: https://ai.google.dev/gemini-api/docs
- **Gemini Models**: https://ai.google.dev/gemini-api/docs/models/gemini

---

**Fecha de implementaciÃ³n**: 7 de noviembre de 2025
**VersiÃ³n**: 1.0.0
**Estado**: âœ… ProducciÃ³n

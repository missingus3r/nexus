<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <%- include('partials/theme-init') %>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/mobile-map.css">
    <link rel="stylesheet" href="/css/centinel.css">
    <script src="/js/theme-toggle.js" defer></script>
</head>
<body class="map-page">
    <%- include('partials/header-centinel', { page: page, isAuthenticated: isAuthenticated }) %>

    <div class="main-content map-main">
        <div class="map-container fullscreen-map">
            <div id="map"></div>

            <!-- Controles flotantes para mobile -->
            <div class="floating-controls mobile-only">
                <button id="filtersBtn" class="floating-btn" title="Filtros">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="4" y1="6" x2="20" y2="6"></line>
                        <line x1="4" y1="12" x2="20" y2="12"></line>
                        <line x1="4" y1="18" x2="20" y2="18"></line>
                        <circle cx="8" cy="6" r="2"></circle>
                        <circle cx="16" cy="12" r="2"></circle>
                        <circle cx="12" cy="18" r="2"></circle>
                    </svg>
                </button>

                <% if (isAuthenticated) { %>
                    <button id="reportBtnMobile" class="floating-btn primary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                <% } %>

                <button id="layersBtn" class="floating-btn" title="Capas">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                        <polyline points="2 17 12 22 22 17"></polyline>
                        <polyline points="2 12 12 17 22 12"></polyline>
                    </svg>
                </button>

                <button id="incidentsListBtn" class="floating-btn" title="Lista de Incidentes">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"></line>
                        <line x1="8" y1="12" x2="21" y2="12"></line>
                        <line x1="8" y1="18" x2="21" y2="18"></line>
                        <line x1="3" y1="6" x2="3.01" y2="6"></line>
                        <line x1="3" y1="12" x2="3.01" y2="12"></line>
                        <line x1="3" y1="18" x2="3.01" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Desktop floating button for incidents list -->
            <button id="incidentsListBtnDesktop" class="incidents-list-btn desktop-only" title="Últimos Incidentes">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                <span>Últimos Incidentes</span>
            </button>

            <!-- Desktop controls -->
            <div class="map-controls desktop-only">
                <h3>Filtros</h3>
                <div class="form-group">
                    <label for="typeFilter">Tipo de Incidente:</label>
                    <select id="typeFilter">
                        <option value="todos">Todos</option>
                        <option value="homicidio">Homicidio</option>
                        <option value="rapiña">Rapiña</option>
                        <option value="hurto">Hurto</option>
                        <option value="copamiento">Copamiento</option>
                        <option value="violencia_domestica">Violencia Doméstica</option>
                        <option value="narcotrafico">Narcotráfico</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>

                <% if (isAuthenticated) { %>
                    <button id="reportBtn" class="btn btn-danger" style="width: 100%; margin-top: 0.5rem;">
                        Reportar Incidente
                    </button>
                <% } %>

                <div class="layer-controls">
                    <label>
                        <input type="checkbox" id="showIncidents" checked>
                        Incidentes
                    </label>
                    <label>
                        <input type="checkbox" id="showHeatmap" checked>
                        Heatmap
                    </label>
                </div>
            </div>
        </div>

        <!-- Modal Filtros Mobile -->
        <div id="filtersModal" class="bottom-sheet mobile-only">
            <div class="bottom-sheet-content">
                <div class="bottom-sheet-header">
                    <h3>Filtros</h3>
                    <button class="close-sheet">&times;</button>
                </div>
                <div class="bottom-sheet-body">
                    <div class="form-group">
                        <label for="typeFilterMobile">Tipo de Incidente:</label>
                        <select id="typeFilterMobile">
                            <option value="todos">Todos</option>
                            <option value="homicidio">Homicidio</option>
                            <option value="rapiña">Rapiña</option>
                            <option value="hurto">Hurto</option>
                            <option value="copamiento">Copamiento</option>
                            <option value="violencia_domestica">Violencia Doméstica</option>
                            <option value="narcotrafico">Narcotráfico</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Capas Mobile -->
        <div id="layersModal" class="bottom-sheet mobile-only">
            <div class="bottom-sheet-content">
                <div class="bottom-sheet-header">
                    <h3>Capas del Mapa</h3>
                    <button class="close-sheet">&times;</button>
                </div>
                <div class="bottom-sheet-body">
                    <div class="layer-controls">
                        <label>
                            <input type="checkbox" id="showIncidentsMobile" checked>
                            Mostrar Incidentes
                        </label>
                        <label>
                            <input type="checkbox" id="showHeatmapMobile" checked>
                            Mostrar Heatmap
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Acerca de Mobile -->
        <div id="aboutModal" class="bottom-sheet mobile-only">
            <div class="bottom-sheet-content">
                <div class="bottom-sheet-header">
                    <h3>Acerca de Vortex</h3>
                    <button class="close-sheet">&times;</button>
                </div>
                <div class="bottom-sheet-body">
                    <p>&copy; 2025 Vortex - Plataforma de Seguridad Ciudadana</p>
                    <p style="margin-top: 1rem;">
                        <a href="/privacy" style="color: var(--primary-color); text-decoration: none;">Privacidad</a> |
                        <a href="/terms" style="color: var(--primary-color); text-decoration: none;">Términos</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Modal Lista de Incidentes -->
        <div id="incidentsListModal" class="modal">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 1.5rem; border-radius: 8px 8px 0 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.5rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"></line>
                            <line x1="8" y1="12" x2="21" y2="12"></line>
                            <line x1="8" y1="18" x2="21" y2="18"></line>
                            <line x1="3" y1="6" x2="3.01" y2="6"></line>
                            <line x1="3" y1="12" x2="3.01" y2="12"></line>
                            <line x1="3" y1="18" x2="3.01" y2="18"></line>
                        </svg>
                        Últimos Incidentes
                    </h2>
                    <button id="incidentsListModalClose" class="modal-close" style="color: white; opacity: 0.9;">&times;</button>
                </div>
                <div id="incidentsListContent" style="max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                    <p class="text-center" style="padding: 3rem 1rem; color: #757575;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: block; margin: 0 auto 1rem;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Cargando incidentes...
                    </p>
                </div>
            </div>
        </div>

        <div id="reportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Reportar Incidente</h2>
                    <button id="modalClose" class="modal-close">&times;</button>
                </div>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="locationType">Tipo de Ubicación:</label>
                        <select id="locationType" name="locationType" required>
                            <option value="exact">Ubicación Exacta</option>
                            <option value="approximate">Zona Aproximada</option>
                        </select>
                        <small style="color: var(--text-secondary);">
                            <span id="locationTypeHelp">Haz click en el mapa para marcar la ubicación exacta</span>
                        </small>
                    </div>

                    <div class="form-group" id="radiusGroup" style="display: none;">
                        <label for="approximateRadius">Radio de la zona (metros):</label>
                        <input type="range" id="approximateRadius" name="approximateRadius" min="50" max="500" value="100" step="50">
                        <span id="radiusValue">100m</span>
                    </div>

                    <div class="form-group">
                        <button type="button" id="selectLocationBtn" class="btn btn-primary" style="width: 100%;">
                            📍 Seleccionar en el Mapa
                        </button>
                        <div id="locationInfo" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary); display: none;">
                            <strong>Ubicación seleccionada:</strong><br>
                            Lat: <span id="selectedLat">-</span>, Lon: <span id="selectedLon">-</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="type">Tipo:</label>
                        <select id="type" name="type" required>
                            <option value="">Seleccionar...</option>
                            <option value="homicidio">Homicidio</option>
                            <option value="rapiña">Rapiña</option>
                            <option value="hurto">Hurto</option>
                            <option value="copamiento">Copamiento</option>
                            <option value="violencia_domestica">Violencia Doméstica</option>
                            <option value="narcotrafico">Narcotráfico</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="severity">Severidad (1-5):</label>
                        <input type="range" id="severity" name="severity" min="1" max="5" value="3">
                        <span id="severityValue">3</span>
                        <div id="severityExplanation" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.875rem; color: var(--text-secondary); display: none;">
                            <strong>Severidad sugerida:</strong> <span id="severityReason"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripción:</label>
                        <textarea id="description" name="description" maxlength="1000" placeholder="Describe el incidente..."></textarea>
                        <small><span id="charCount">0</span>/1000</small>
                    </div>

                    <div class="form-group">
                        <label for="photos">Fotos (opcional - máximo 3):</label>
                        <input type="file" id="photos" name="photos" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
                        <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                            Formatos: JPG, PNG, WEBP. Máximo 5MB por foto.
                        </small>
                        <div id="photoPreview" style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;"></div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Reportar</button>
                        <button type="button" class="btn btn-secondary" onclick="closeReportModal();">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Bienvenida -->
        <div id="welcomeModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 8px 8px 0 0;">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 12px; font-size: 1.8rem;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                            <path d="M2 17l10 5 10-5"></path>
                            <path d="M2 12l10 5 10-5"></path>
                        </svg>
                        Bienvenido a VORTEX Centinel
                    </h2>
                    <button id="welcomeModalClose" class="modal-close" style="color: white; opacity: 0.9;">&times;</button>
                </div>
                <div style="padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #333; margin-bottom: 0.75rem; font-size: 1.3rem;">¿Qué es Centinel?</h3>
                        <p style="color: #555; line-height: 1.7; font-size: 1rem;">
                            Centinel es tu plataforma de <strong>seguridad ciudadana en tiempo real</strong>.
                            Una herramienta colaborativa que permite a la comunidad reportar, visualizar y mantenerse
                            informada sobre incidentes de seguridad en Uruguay.
                        </p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="color: #333; margin-bottom: 0.75rem; font-size: 1.3rem;">Funcionalidades Principales</h3>
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="background: #e3f2fd; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                                <div>
                                    <strong style="color: #333; display: block; margin-bottom: 0.25rem;">Mapa Interactivo en Tiempo Real</strong>
                                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Visualiza incidentes geolocalizados y heatmaps de zonas de riesgo actualizados constantemente.</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="background: #f3e5f5; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7b1fa2" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="12" y1="18" x2="12" y2="12"></line>
                                        <line x1="9" y1="15" x2="15" y2="15"></line>
                                    </svg>
                                </div>
                                <div>
                                    <strong style="color: #333; display: block; margin-bottom: 0.25rem;">Reportar Incidentes</strong>
                                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Contribuye a la comunidad reportando incidentes con ubicación exacta o aproximada, fotos y detalles.</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="background: #fff3e0; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
                                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <strong style="color: #333; display: block; margin-bottom: 0.25rem;">Noticias de Seguridad Geolocalizadas</strong>
                                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Accede a noticias de seguridad cercanas a tu ubicación y mantente informado.</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="background: #e8f5e9; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                </div>
                                <div>
                                    <strong style="color: #333; display: block; margin-bottom: 0.25rem;">Foro Comunitario</strong>
                                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Participa en discusiones sobre seguridad ciudadana y comparte experiencias.</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <div style="background: #fce4ec; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#c2185b" stroke-width="2">
                                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                    </svg>
                                </div>
                                <div>
                                    <strong style="color: #333; display: block; margin-bottom: 0.25rem;">Enlaces Oficiales</strong>
                                    <p style="color: #666; margin: 0; font-size: 0.95rem;">Acceso directo a recursos del Ministerio del Interior y organismos oficiales.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f5f5f5; border-left: 4px solid #667eea; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                        <p style="margin: 0; color: #555; font-size: 0.95rem;">
                            <strong>💡 Consejo:</strong> Mantén activada tu ubicación para obtener información más precisa de tu zona.
                        </p>
                    </div>

                    <button onclick="closeWelcomeModal();" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        ¡Comenzar a Explorar!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer desktop-only">
        <%- include('partials/footer') %>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/map.js"></script>
    <script src="/js/centinel.js"></script>
</body>
</html>

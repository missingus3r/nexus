<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <%- include('partials/theme-init') %>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme-toggle.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="/js/theme-toggle.js" defer></script>
</head>
</head>
<body>
    <%- include('partials/header', { page: page, isAuthenticated: isAuthenticated }) %>

    <div class="main-content">
        <div class="container">
            <div class="admin-header">
                <h1>Panel de Administraci√≥n</h1>
                <p>Vista general de estad√≠sticas y m√©tricas de la plataforma</p>
            </div>

            <div id="statsContainer" class="loading">
                <p>Cargando estad√≠sticas...</p>
            </div>

            <!-- Users Management -->
            <div class="surlink-controls">
                <h2>üë• Usuarios Registrados</h2>
                <p>
                    Estad√≠sticas y lista de usuarios registrados en la plataforma.
                </p>

                <div id="userStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas de usuarios...</p>
                </div>

                <div id="recentUsersContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">Usuarios Recientes</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">Email</th>
                                    <th style="padding: 1rem; text-align: left;">Nombre</th>
                                    <th style="padding: 1rem; text-align: left;">Rol</th>
                                    <th style="padding: 1rem; text-align: left;">Registro</th>
                                    <th style="padding: 1rem; text-align: left;">√öltimo Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="userManagementContainer" data-visible="true" style="display: block; margin-top: 2rem;">
                    <div class="user-management-header" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;">
                        <h3 style="margin: 0;">Gesti√≥n de Usuarios</h3>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <input
                                type="text"
                                id="userSearchInput"
                                placeholder="Buscar por email o nombre"
                                style="flex: 1; min-width: 220px; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary);"
                            >
                            <button class="btn btn-secondary" id="userSearchBtn">Buscar</button>
                            <button class="btn btn-secondary" id="refreshUserListBtn">Actualizar</button>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; min-width: 720px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color); text-align: left;">
                                    <th style="padding: 1rem;">Email</th>
                                    <th style="padding: 1rem;">Nombre</th>
                                    <th style="padding: 1rem;">Rol</th>
                                    <th style="padding: 1rem;">Estado</th>
                                    <th style="padding: 1rem;">Registro</th>
                                    <th style="padding: 1rem;">√öltimo acceso</th>
                                    <th style="padding: 1rem;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTableBody">
                                <tr>
                                    <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                        Cargando usuarios...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Controls -->
                    <div id="userPaginationContainer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">
                            <span id="userPaginationInfo">Mostrando 0 de 0 usuarios</span>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-secondary" id="userPrevPageBtn" disabled>
                                ‚Üê Anterior
                            </button>
                            <span id="userCurrentPage" style="padding: 0 1rem; color: var(--text-primary);">
                                P√°gina 1 de 1
                            </span>
                            <button class="btn btn-secondary" id="userNextPageBtn" disabled>
                                Siguiente ‚Üí
                            </button>
                        </div>
                    </div>

                    <div id="userManagementStatus" class="status-message" style="display: none; margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Forum Management -->
            <div class="surlink-controls">
                <h2>üí¨ Gesti√≥n del Foro Vortex</h2>
                <p>
                    Configura los l√≠mites de publicaci√≥n y visualiza estad√≠sticas de actividad del foro.
                </p>

                <!-- Forum Stats -->
                <div id="forumStatsContainer" class="forum-stats-card loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas del foro...</p>
                </div>

                <!-- Forum Settings -->
                <div id="forumSettingsContainer" class="forum-settings-panel" style="margin-top: 2rem; display: none;">
                    <div class="forum-settings-header">
                        <div>
                            <h3>‚öôÔ∏è Configuraci√≥n del Foro</h3>
                            <p>Define l√≠mites y permisos para mantener el foro sano y ordenado.</p>
                        </div>
                    </div>

                    <div class="forum-settings-grid">
                        <div class="forum-settings-card">
                            <div class="forum-settings-icon">‚è±Ô∏è</div>
                            <div class="forum-settings-content">
                                <label for="postCooldownMinutes">
                                    Tiempo entre threads (min)
                                    <span>Tiempo m√≠nimo que debe esperar un usuario entre crear threads.</span>
                                </label>
                                <input type="number" id="postCooldownMinutes" min="0" max="1440" />
                            </div>
                        </div>

                        <div class="forum-settings-card">
                            <div class="forum-settings-icon">üí¨</div>
                            <div class="forum-settings-content">
                                <label for="maxCommentsPerDay">
                                    Comentarios por d√≠a
                                    <span>L√≠mite de comentarios que puede publicar un usuario en 24 horas.</span>
                                </label>
                                <input type="number" id="maxCommentsPerDay" min="1" max="1000" />
                            </div>
                        </div>

                        <div class="forum-settings-card compact">
                            <div class="forum-settings-icon">üñºÔ∏è</div>
                            <div class="forum-settings-content">
                                <label class="forum-checkbox">
                                    <input type="checkbox" id="allowImages" />
                                    <div class="forum-checkbox-text">
                                        <span class="forum-setting-title">Permitir subida de im√°genes</span>
                                        <span class="forum-setting-description">Habilita que los usuarios adjunten im√°genes en sus threads.</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="forum-settings-card compact">
                            <div class="forum-settings-icon">üîó</div>
                            <div class="forum-settings-content">
                                <label class="forum-checkbox">
                                    <input type="checkbox" id="allowLinks" />
                                    <div class="forum-checkbox-text">
                                        <span class="forum-setting-title">Permitir enlaces externos</span>
                                        <span class="forum-setting-description">Controla si los usuarios pueden compartir URLs en sus publicaciones.</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="forum-settings-card">
                            <div class="forum-settings-icon">üñºÔ∏è+</div>
                            <div class="forum-settings-content">
                                <label for="maxImagesPerPost">
                                    M√°ximo de im√°genes por post
                                    <span>Cu√°ntas im√°genes se pueden subir en un √∫nico thread.</span>
                                </label>
                                <input type="number" id="maxImagesPerPost" min="0" max="10" />
                            </div>
                        </div>
                    </div>

                    <div class="forum-settings-actions button-group">
                        <button class="btn btn-primary" onclick="saveForumSettings()">
                            üíæ Guardar configuraci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="loadForumSettings()">
                            üîÑ Recargar
                        </button>
                    </div>

                    <div id="forumSettingsStatus" class="status-message" style="margin-top: 1rem;"></div>
                </div>

                <!-- Top Content -->
                <div id="forumTopContent" class="forum-top-content" style="margin-top: 2rem; display: none;">
                    <div class="forum-top-grid">
                        <div class="forum-top-card span-2">
                            <h3>‚≠ê Threads m√°s populares</h3>
                            <p class="forum-top-subtitle">√öltima semana de actividad destacada.</p>
                            <div id="popularThreadsContainer" class="forum-top-list"></div>
                        </div>
                        <div class="forum-top-card">
                            <h3>üë• Usuarios m√°s activos</h3>
                            <p class="forum-top-subtitle">Ranking de participaci√≥n por tipo de aporte.</p>
                            <div class="forum-top-users-grid">
                                <div class="forum-top-subcard">
                                    <h4>Por threads</h4>
                                    <div id="topThreadAuthorsContainer" class="forum-top-list"></div>
                                </div>
                                <div class="forum-top-subcard">
                                    <h4>Por comentarios</h4>
                                    <div id="topCommentAuthorsContainer" class="forum-top-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Management -->
            <div class="surlink-controls">
                <h2>üö® Gesti√≥n de Reportes</h2>
                <p>
                    Administra los reportes de contenido inapropiado realizados por los usuarios del foro.
                </p>

                <!-- Reports Stats -->
                <div id="reportsStatsContainer" style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: var(--surface); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--warning-color);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Reportes Pendientes</div>
                        <div id="pendingReportsCount" style="font-size: 2rem; font-weight: bold; color: var(--warning-color);">-</div>
                    </div>
                    <div style="background: var(--surface); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total de Reportes</div>
                        <div id="totalReportsCount" style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">-</div>
                    </div>
                    <div style="background: var(--surface); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success-color);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Resueltos</div>
                        <div id="resolvedReportsCount" style="font-size: 2rem; font-weight: bold; color: var(--success-color);">-</div>
                    </div>
                </div>

                <!-- Reports Filters -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <div>
                        <label for="reportStatusFilter" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">Estado</label>
                        <select id="reportStatusFilter" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--surface); color: var(--text-primary);">
                            <option value="">Todos</option>
                            <option value="pending" selected>Pendientes</option>
                            <option value="reviewed">Revisados</option>
                            <option value="resolved">Resueltos</option>
                            <option value="rejected">Rechazados</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportTypeFilter" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">Tipo</label>
                        <select id="reportTypeFilter" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--surface); color: var(--text-primary);">
                            <option value="">Todos</option>
                            <option value="thread">Threads</option>
                            <option value="comment">Comentarios</option>
                            <option value="user">Usuarios</option>
                        </select>
                    </div>
                    <button id="refreshReportsBtn" class="btn btn-secondary" style="margin-top: auto;">Actualizar</button>
                </div>

                <!-- Reports List -->
                <div style="margin-top: 2rem; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; min-width: 900px;">
                        <thead>
                            <tr style="background: var(--background); border-bottom: 2px solid var(--border-color); text-align: left;">
                                <th style="padding: 1rem;">Tipo</th>
                                <th style="padding: 1rem;">Raz√≥n</th>
                                <th style="padding: 1rem;">Reportado por</th>
                                <th style="padding: 1rem;">Usuario reportado</th>
                                <th style="padding: 1rem;">Estado</th>
                                <th style="padding: 1rem;">Fecha</th>
                                <th style="padding: 1rem;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <tr>
                                <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                    Cargando reportes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Reports Pagination -->
                <div id="reportsPaginationContainer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        <span id="reportsPaginationInfo">Mostrando 0 de 0 reportes</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-secondary" id="reportsPrevPageBtn" disabled>
                            ‚Üê Anterior
                        </button>
                        <span id="reportsCurrentPage" style="padding: 0 1rem; color: var(--text-primary);">
                            P√°gina 1 de 1
                        </span>
                        <button class="btn btn-secondary" id="reportsNextPageBtn" disabled>
                            Siguiente ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Maintenance Controls -->
            <div class="surlink-controls">
                <h2>üîß Modo Mantenimiento</h2>
                <p>
                    Activa o desactiva el modo mantenimiento para cada plataforma. Cuando est√° activo, los usuarios ver√°n un mensaje de mantenimiento.
                </p>

                <div id="maintenanceSettingsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando configuraci√≥n de mantenimiento...</p>
                </div>

                <div id="maintenanceToggles" style="margin-top: 1.5rem; display: none;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
                        <!-- Centinel Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üó∫Ô∏è Centinel (Mapa Principal)</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso al mapa interactivo de incidentes
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-centinel" onchange="toggleMaintenance('centinel')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Surlink Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üè† Surlink</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso a la plataforma de inmuebles y autos
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-surlink" onchange="toggleMaintenance('surlink')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Forum Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üí¨ Foro Vortex</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso al foro de discusiones
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-forum" onchange="toggleMaintenance('forum')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Auth Toggle -->
                        <div class="maintenance-toggle-card" style="border: 2px solid var(--warning-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üîê Login y Registro</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--warning-color); font-size: 0.9rem; font-weight: 600;">
                                        ‚ö†Ô∏è ADVERTENCIA: Desactiva login/registro (solo admins podr√°n acceder v√≠a Auth0 en /admin)
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-auth" onchange="toggleMaintenance('auth')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="maintenanceStatus" class="status-message" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Maintenance Utilities -->
            <div class="surlink-controls">
                <h2>üßº Herramientas de Limpieza</h2>
                <p>
                    Ejecuta manualmente la limpieza programada del sistema o depura los listados de Surlink por categor√≠a.
                </p>

                <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 1.5rem;">
                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px;">
                        <h3 style="margin-top: 0;">üßπ Limpieza Programada</h3>
                        <p style="color: var(--text-secondary); font-size: 0.95rem;">
                            Ejecuta al instante el proceso nocturno: elimina incidentes pendientes antiguos, archiva validaciones y borra archivos hu√©rfanos.
                        </p>
                        <button class="btn btn-primary btn-icon" id="runScheduledCleanupBtn" onclick="triggerScheduledCleanup()">
                            ‚ñ∂Ô∏è Ejecutar limpieza
                        </button>
                        <div id="scheduledCleanupStatus" class="status-message" style="margin-top: 1rem;"></div>
                    </div>

                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px;">
                        <h3 style="margin-top: 0;">üóëÔ∏è Limpieza Surlink</h3>
                        <p style="color: var(--text-secondary); font-size: 0.95rem;">
                            Elimina definitivamente los listados de Surlink para una categor√≠a espec√≠fica o limpia toda la colecci√≥n.
                        </p>
                        <label for="surlinkCleanupCategory" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Categor√≠a</label>
                        <select id="surlinkCleanupCategory" style="width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary); margin-bottom: 1rem;">
                            <option value="all">Todas</option>
                            <option value="casas">Casas</option>
                            <option value="autos">Autos</option>
                            <option value="academy">Academy</option>
                            <option value="financial">Financial</option>
                        </select>
                        <button class="btn btn-danger btn-icon" id="surlinkCleanupBtn" onclick="purgeSurlinkListings()">
                            üßΩ Limpiar listados
                        </button>
                        <div id="surlinkCleanupStatus" class="status-message" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>

            <!-- Page Visits Analytics -->
            <div class="surlink-controls">
                <h2>üìä An√°lisis de Visitas a P√°ginas</h2>
                <p>
                    Estad√≠sticas de visitas a las p√°ginas del sistema, con informaci√≥n de usuarios autenticados e IPs an√≥nimas.
                </p>

                <!-- Visit Stats -->
                <div id="visitStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas de visitas...</p>
                </div>

                <!-- Top Pages -->
                <div id="topPagesContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">üìÑ P√°ginas M√°s Visitadas</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">P√°gina</th>
                                    <th style="padding: 1rem; text-align: center;">Total Visitas</th>
                                    <th style="padding: 1rem; text-align: center;">Autenticados</th>
                                    <th style="padding: 1rem; text-align: center;">An√≥nimos</th>
                                    <th style="padding: 1rem; text-align: center;">Visitantes √önicos</th>
                                </tr>
                            </thead>
                            <tbody id="topPagesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Visits -->
                <div id="recentVisitsContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">üïê Visitas Recientes (√öltimas 5)</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">P√°gina</th>
                                    <th style="padding: 1rem; text-align: left;">Usuario / IP</th>
                                    <th style="padding: 1rem; text-align: left;">Fecha y Hora</th>
                                </tr>
                            </thead>
                            <tbody id="recentVisitsTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="openAllVisitsModal()">
                            üìã Ver todas las visitas
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cron Jobs Management -->
            <div class="surlink-controls">
                <h2>‚è∞ Gesti√≥n de Cron Jobs</h2>
                <p>
                    Configura los horarios de ejecuci√≥n autom√°tica de tareas programadas del sistema.
                </p>

                <div id="cronSettingsContainer" class="loading" style="margin-top: 1.5rem;">
                    <p>Cargando configuraci√≥n de cron jobs...</p>
                </div>

                <div id="cronSettingsPanel" style="display: none; margin-top: 1.5rem;">
                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Estado de Cron Jobs</h3>
                            <label class="toggle-switch">
                                <input type="checkbox" id="cronEnabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                            Activa o desactiva la ejecuci√≥n autom√°tica de todas las tareas programadas.
                        </p>
                    </div>

                    <div style="display: grid; gap: 1.5rem;">
                        <!-- News Ingestion -->
                        <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; gap: 0.5rem; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 250px;">
                                    <h4 style="margin: 0 0 0.5rem 0;">üì∞ Ingesta de Noticias</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0 0 1rem 0;">
                                        Carga autom√°tica de noticias desde feeds RSS configurados.
                                    </p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn btn-secondary" onclick="runCronJobManually('newsIngestion')" style="white-space: nowrap;">
                                        ‚ñ∂Ô∏è Ejecutar ahora
                                    </button>
                                    <button class="btn btn-danger" onclick="clearNews()" id="clearNewsBtn" style="white-space: nowrap;">
                                        üóëÔ∏è Limpiar Noticias
                                    </button>
                                </div>
                            </div>
                            <label for="cronNewsIngestion" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                                Expresi√≥n Cron
                            </label>
                            <input
                                type="text"
                                id="cronNewsIngestion"
                                placeholder="0 */6 * * *"
                                style="width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary); font-family: monospace;"
                            >
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                Formato: minuto hora d√≠a mes d√≠a-de-semana. Ejemplo: "0 */6 * * *" (cada 6 horas)
                            </small>
                        </div>

                        <!-- Cleanup -->
                        <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0;">üßπ Limpieza del Sistema</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0 0 1rem 0;">
                                        Elimina incidentes pendientes antiguos, archiva validaciones y borra archivos hu√©rfanos.
                                    </p>
                                </div>
                                <button class="btn btn-secondary" onclick="runCronJobManually('cleanup')" style="white-space: nowrap;">
                                    ‚ñ∂Ô∏è Ejecutar ahora
                                </button>
                            </div>
                            <label for="cronCleanup" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                                Expresi√≥n Cron
                            </label>
                            <input
                                type="text"
                                id="cronCleanup"
                                placeholder="0 2 * * *"
                                style="width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary); font-family: monospace;"
                            >
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                Ejemplo: "0 2 * * *" (todos los d√≠as a las 2 AM)
                            </small>
                        </div>

                        <!-- Heatmap Update -->
                        <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0;">üó∫Ô∏è Actualizaci√≥n de Heatmap</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0 0 1rem 0;">
                                        Recalcula los percentiles del heatmap de incidentes para colorear correctamente las zonas.
                                    </p>
                                </div>
                                <button class="btn btn-secondary" onclick="runCronJobManually('heatmapUpdate')" style="white-space: nowrap;">
                                    ‚ñ∂Ô∏è Ejecutar ahora
                                </button>
                            </div>
                            <label for="cronHeatmapUpdate" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                                Expresi√≥n Cron
                            </label>
                            <input
                                type="text"
                                id="cronHeatmapUpdate"
                                placeholder="0 * * * *"
                                style="width: 100%; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary); font-family: monospace;"
                            >
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                Ejemplo: "0 * * * *" (cada hora en punto)
                            </small>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="saveCronSettings()">
                            üíæ Guardar Configuraci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="loadCronSettings()">
                            üîÑ Recargar
                        </button>
                    </div>

                    <div id="cronSettingsStatus" class="status-message" style="margin-top: 1rem;"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial de Pagos</h2>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentHistoryContainer">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <!-- All Visits Modal -->
    <div id="allVisitsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üìã Historial completo de visitas</h2>
                <button class="modal-close" onclick="closeAllVisitsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="loadAllVisits()">üîÑ Actualizar listado</button>
                    <button class="btn btn-danger" onclick="deleteVisits(50)">üóëÔ∏è Eliminar √∫ltimas 50</button>
                    <button class="btn btn-danger" onclick="deleteVisits('all')">üí• Eliminar todas</button>
                </div>
                <div style="max-height: 60vh; overflow: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background: var(--surface); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <tr>
                                <th style="padding: 0.75rem 1rem; text-align: left;">P√°gina</th>
                                <th style="padding: 0.75rem 1rem; text-align: left;">Usuario / IP</th>
                                <th style="padding: 0.75rem 1rem; text-align: left;">Fecha y Hora</th>
                            </tr>
                        </thead>
                        <tbody id="allVisitsTableBody"></tbody>
                    </table>
                </div>
                <div id="allVisitsStatus" class="status-message" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportDetailsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 800px; margin: 2rem auto; background: var(--surface); border-radius: 8px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Detalles del Reporte</h2>
                <button onclick="closeReportDetailsModal()" style="background: transparent; border: none; font-size: 2rem; cursor: pointer; color: var(--text-primary);">&times;</button>
            </div>

            <div id="reportDetailsContent">
                <p style="text-align: center; color: var(--text-secondary);">Cargando...</p>
            </div>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h3 style="margin-bottom: 1rem;">Acciones del Administrador</h3>

                <div style="margin-bottom: 1rem;">
                    <label for="resolutionText" style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Notas de resoluci√≥n</label>
                    <textarea id="resolutionText" placeholder="Escribe notas sobre la acci√≥n tomada..." style="width: 100%; min-height: 100px; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--background); color: var(--text-primary);"></textarea>
                </div>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="updateReportStatus('reviewed')" class="btn btn-secondary">Marcar como Revisado</button>
                    <button onclick="updateReportStatus('resolved')" class="btn btn-primary">Resolver</button>
                    <button onclick="updateReportStatus('rejected')" class="btn" style="background: var(--danger-color); color: white;">Rechazar</button>
                    <button onclick="deleteReport()" class="btn" style="background: var(--danger-color); color: white; margin-left: auto;">Eliminar Reporte</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/admin.js"></script>
    <script src="/js/admin-reports.js"></script>
</body>
</html>

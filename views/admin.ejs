<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <%- include('partials/theme-init') %>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme-toggle.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="/js/theme-toggle.js" defer></script>
</head>
</head>
<body>
    <%- include('partials/header', { page: page, isAuthenticated: isAuthenticated }) %>

    <div class="main-content">
        <div class="container">
            <div class="admin-header">
                <h1>Panel de Administraci√≥n</h1>
                <p>Vista general de estad√≠sticas y m√©tricas de la plataforma</p>
            </div>

            <div id="statsContainer" class="loading">
                <p>Cargando estad√≠sticas...</p>
            </div>

            <!-- Users Management -->
            <div class="surlink-controls">
                <h2>üë• Usuarios Registrados</h2>
                <p>
                    Estad√≠sticas y lista de usuarios registrados en la plataforma.
                </p>

                <div id="userStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas de usuarios...</p>
                </div>

                <div id="recentUsersContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">Usuarios Recientes</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">Email</th>
                                    <th style="padding: 1rem; text-align: left;">Nombre</th>
                                    <th style="padding: 1rem; text-align: left;">Rol</th>
                                    <th style="padding: 1rem; text-align: left;">Registro</th>
                                    <th style="padding: 1rem; text-align: left;">√öltimo Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- News Controls -->
            <div class="news-controls">
                <h2>üì∞ Control de Noticias RSS</h2>

                <div class="control-group">
                    <p style="color: var(--text-secondary); margin: 0;">
                        Las noticias se filtran autom√°ticamente por palabras clave de seguridad configuradas en el sistema.
                        Solo se indexar√°n noticias relacionadas con: homicidio, rapi√±a, hurto, violencia, narcotr√°fico, etc.
                    </p>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadNews()" id="loadNewsBtn">
                        üì• Cargar Noticias de Seguridad
                    </button>
                    <button class="btn btn-danger" onclick="clearNews()" id="clearNewsBtn">
                        üóëÔ∏è Limpiar Todas las Noticias
                    </button>
                </div>

                <div id="newsStatus" class="status-message"></div>
            </div>

            <!-- Surlink Controls -->
            <div class="surlink-controls">
                <h2>üåê Vortex Surlink</h2>
                <p>
                    Gestion√° el agregador de inmuebles y autos. Estos controles preparan las automatizaciones futuras
                    para el scrapping y la depuraci√≥n de listados caducados.
                </p>

                <div class="button-group">
                    <button class="btn btn-primary" id="surlinkCasasBtn" onclick="scheduleSurlinkIngest('casas')">
                        üöÄ Scraping Surlink Casas
                    </button>
                    <button class="btn btn-primary" id="surlinkAutosBtn" onclick="scheduleSurlinkIngest('autos')">
                        üöó Scraping Surlink Autos
                    </button>
                    <button class="btn btn-secondary" id="surlinkCleanupBtn" onclick="cleanupSurlinkListings()">
                        üßπ Depurar Listados Caducados
                    </button>
                </div>

                <div id="surlinkStatus" class="status-message info" style="display: none;"></div>
            </div>

            <!-- Subscriptions Dashboard -->
            <div class="surlink-controls">
                <h2>üí≥ Gesti√≥n de Suscripciones</h2>
                <p>
                    Dashboard de suscripciones con m√©tricas de ingresos, planes activos y gesti√≥n de usuarios.
                </p>

                <!-- Export Buttons -->
                <div class="export-buttons">
                    <button class="btn btn-success btn-icon" onclick="exportSubscriptions('csv')">
                        üìÑ Exportar CSV
                    </button>
                    <button class="btn btn-success btn-icon" onclick="exportSubscriptions('excel')">
                        üìä Exportar Excel
                    </button>
                </div>

                <div id="subscriptionStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas de suscripciones...</p>
                </div>

                <!-- Trend Charts -->
                <div class="charts-grid" id="chartsContainer" style="display: none;">
                    <div class="chart-card">
                        <h3>Suscripciones por Mes</h3>
                        <canvas id="subscriptionsTrendChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Ingresos por Plan</h3>
                        <canvas id="revenuePlanChart"></canvas>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-container" style="margin-top: 2rem;">
                    <h3 style="margin-top: 0;">Filtros</h3>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>Estado</label>
                            <select id="filterStatus" onchange="applyFilters()">
                                <option value="">Todos</option>
                                <option value="active">Activas</option>
                                <option value="expired">Expiradas</option>
                                <option value="cancelled">Canceladas</option>
                                <option value="trial">Prueba</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Plan</label>
                            <select id="filterPlan" onchange="applyFilters()">
                                <option value="">Todos</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                                <option value="pro">Pro</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Tipo</label>
                            <select id="filterPlanType" onchange="applyFilters()">
                                <option value="">Todos</option>
                                <option value="personal">Personal</option>
                            </select>
                        </div>
                        <div class="filter-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="clearFilters()" style="width: 100%;">
                                Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Suscripciones</h3>
                    <div id="recentSubscriptionsContainer"></div>
                </div>
            </div>

            <!-- Forum Management -->
            <div class="surlink-controls">
                <h2>üí¨ Gesti√≥n del Foro Vortex</h2>
                <p>
                    Configura los l√≠mites de publicaci√≥n y visualiza estad√≠sticas de actividad del foro.
                </p>

                <!-- Forum Stats -->
                <div id="forumStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas del foro...</p>
                </div>

                <!-- Forum Settings -->
                <div id="forumSettingsContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">‚öôÔ∏è Configuraci√≥n del Foro</h3>

                    <div class="control-group">
                        <label for="postCooldownMinutes">
                            Tiempo entre threads (minutos)
                            <small>Tiempo m√≠nimo que debe esperar un usuario entre crear threads</small>
                        </label>
                        <input type="number" id="postCooldownMinutes" min="0" max="1440" />
                    </div>

                    <div class="control-group">
                        <label for="maxCommentsPerDay">
                            L√≠mite de comentarios por d√≠a
                            <small>N√∫mero m√°ximo de comentarios que un usuario puede publicar en 24 horas</small>
                        </label>
                        <input type="number" id="maxCommentsPerDay" min="1" max="1000" />
                    </div>

                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="allowImages" />
                            Permitir subida de im√°genes
                        </label>
                    </div>

                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="allowLinks" />
                            Permitir enlaces en posts
                        </label>
                    </div>

                    <div class="control-group">
                        <label for="maxImagesPerPost">
                            M√°ximo de im√°genes por post
                            <small>N√∫mero m√°ximo de im√°genes que se pueden subir en un thread</small>
                        </label>
                        <input type="number" id="maxImagesPerPost" min="0" max="10" />
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="saveForumSettings()">
                            üíæ Guardar Configuraci√≥n
                        </button>
                        <button class="btn btn-secondary" onclick="loadForumSettings()">
                            üîÑ Recargar
                        </button>
                    </div>

                    <div id="forumSettingsStatus" class="status-message"></div>
                </div>

                <!-- Top Content -->
                <div id="forumTopContent" style="margin-top: 2rem; display: none;">
                    <h3>‚≠ê Threads M√°s Populares</h3>
                    <div id="popularThreadsContainer" style="margin-top: 1rem;"></div>

                    <h3 style="margin-top: 2rem;">üë• Usuarios M√°s Activos</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">Por Threads</h4>
                            <div id="topThreadAuthorsContainer"></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">Por Comentarios</h4>
                            <div id="topCommentAuthorsContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Maintenance Controls -->
            <div class="surlink-controls">
                <h2>üîß Modo Mantenimiento</h2>
                <p>
                    Activa o desactiva el modo mantenimiento para cada plataforma. Cuando est√° activo, los usuarios ver√°n un mensaje de mantenimiento.
                </p>

                <div id="maintenanceSettingsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando configuraci√≥n de mantenimiento...</p>
                </div>

                <div id="maintenanceToggles" style="margin-top: 1.5rem; display: none;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
                        <!-- Centinel Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üó∫Ô∏è Centinel (Mapa Principal)</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso al mapa interactivo de incidentes
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-centinel" onchange="toggleMaintenance('centinel')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Surlink Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üè† Surlink</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso a la plataforma de inmuebles y autos
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-surlink" onchange="toggleMaintenance('surlink')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Forum Toggle -->
                        <div class="maintenance-toggle-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üí¨ Foro Vortex</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        Desactiva el acceso al foro de discusiones
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-forum" onchange="toggleMaintenance('forum')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Auth Toggle -->
                        <div class="maintenance-toggle-card" style="border: 2px solid var(--warning-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 1.1rem;">üîê Login y Registro</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--warning-color); font-size: 0.9rem; font-weight: 600;">
                                        ‚ö†Ô∏è ADVERTENCIA: Desactiva login/registro (solo admins podr√°n acceder v√≠a Auth0 en /admin)
                                    </p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggle-auth" onchange="toggleMaintenance('auth')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="maintenanceStatus" class="status-message" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <!-- Page Visits Analytics -->
            <div class="surlink-controls">
                <h2>üìä An√°lisis de Visitas a P√°ginas</h2>
                <p>
                    Estad√≠sticas de visitas a las p√°ginas del sistema, con informaci√≥n de usuarios autenticados e IPs an√≥nimas.
                </p>

                <!-- Visit Stats -->
                <div id="visitStatsContainer" class="loading" style="margin-top: 1rem;">
                    <p>Cargando estad√≠sticas de visitas...</p>
                </div>

                <!-- Top Pages -->
                <div id="topPagesContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">üìÑ P√°ginas M√°s Visitadas</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">P√°gina</th>
                                    <th style="padding: 1rem; text-align: center;">Total Visitas</th>
                                    <th style="padding: 1rem; text-align: center;">Autenticados</th>
                                    <th style="padding: 1rem; text-align: center;">An√≥nimos</th>
                                    <th style="padding: 1rem; text-align: center;">Visitantes √önicos</th>
                                </tr>
                            </thead>
                            <tbody id="topPagesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Visits -->
                <div id="recentVisitsContainer" style="margin-top: 2rem; display: none;">
                    <h3 style="margin-bottom: 1rem;">üïê Visitas Recientes (√öltimas 50)</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 1rem; text-align: left;">P√°gina</th>
                                    <th style="padding: 1rem; text-align: left;">Usuario / IP</th>
                                    <th style="padding: 1rem; text-align: left;">Fecha y Hora</th>
                                </tr>
                            </thead>
                            <tbody id="recentVisitsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pricing Management -->
            <div class="surlink-controls">
                <h2>Gesti√≥n de Precios</h2>
                <p>
                    Configura los precios de cada plan y el valor del d√≥lar para conversi√≥n a pesos UYU.
                </p>

                <div id="pricingSettingsContainer" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">‚öôÔ∏è Configuraci√≥n de Precios</h3>

                    <!-- Exchange Rate -->
                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">üí± Tipo de Cambio</h4>
                        <div class="control-group">
                            <label for="usdToUyu">
                                D√≥lar a Peso Uruguayo (USD ‚Üí UYU)
                                <small>Valor actual del d√≥lar en pesos uruguayos</small>
                            </label>
                            <input type="number" id="usdToUyu" min="1" step="0.01" placeholder="44" />
                        </div>
                    </div>

                    <!-- Premium Plan -->
                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem;">Plan Premium</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div class="control-group">
                                <label for="premiumMonthly">
                                    Precio Mensual (USD)
                                </label>
                                <input type="number" id="premiumMonthly" min="0" step="0.01" placeholder="2" />
                            </div>
                            <div class="control-group">
                                <label for="premiumYearly">
                                    Precio Anual (USD)
                                    <small>Sugerido: mensual √ó 12 √ó 0.9</small>
                                </label>
                                <input type="number" id="premiumYearly" min="0" step="0.01" placeholder="22" />
                            </div>
                        </div>
                    </div>

                    <!-- Pro Plan -->
                    <div style="background: var(--surface-elevated); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem;">Plan Pro</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <div class="control-group">
                                <label for="proMonthly">
                                    Precio Mensual (USD)
                                </label>
                                <input type="number" id="proMonthly" min="0" step="0.01" placeholder="5" />
                            </div>
                            <div class="control-group">
                                <label for="proYearly">
                                    Precio Anual (USD)
                                </label>
                                <input type="number" id="proYearly" min="0" step="0.01" placeholder="54" />
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="savePricingSettings()">
                            üíæ Guardar Precios
                        </button>
                        <button class="btn btn-secondary" onclick="loadPricingSettings()">
                            üîÑ Recargar
                        </button>
                    </div>

                    <div id="pricingSettingsStatus" class="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial de Pagos</h2>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="paymentHistoryContainer">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script src="/js/admin.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <%- include('partials/theme-init') %>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/forum-features.css">

    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <script src="/js/preferences-service.js"></script>
    <script src="/js/theme-toggle.js" defer></script>

    <!-- Quill.js -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="/js/auth-utils.js"></script>
    <script src="/js/forum-mentions.js" defer></script>
    <script src="/js/forum-polls.js" defer></script>
    <script src="/js/forum.js" defer></script>
</head>
<body>
    <%- include('partials/header-forum-austra', { page: page, isAuthenticated: isAuthenticated }) %>

    <div class="main-content">
        <div class="container">
            <div class="forum-austra-container" style="max-width: 900px; margin: 0 auto;">

                <!-- Back Button -->
                <a href="/forum" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; text-decoration: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Volver a Selecci칩n de Foro
                </a>

                <!-- Header -->
                <div class="forum-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <p style="margin: 0; color: var(--text-secondary);">Comparte y discute sobre Centinel, Surlink y todos los servicios de Austra</p>
                    </div>
                    <% if (isAuthenticated) { %>
                        <button id="newThreadBtn" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Nuevo Thread
                        </button>
                    <% } else { %>
                        <a href="/login" class="btn btn-primary">Iniciar Sesi칩n para Postear</a>
                    <% } %>
                </div>

                <!-- Navigation Tabs -->
                <div class="forum-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); overflow-x: auto;">
                    <button class="forum-tab active" data-tab="all" onclick="switchForumTab('all')" style="padding: 0.75rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid var(--primary-color); cursor: pointer; color: var(--primary-color); font-weight: 600; white-space: nowrap; margin-bottom: -2px;">
                        Todos los Posts
                    </button>
                    <% if (isAuthenticated) { %>
                        <button class="forum-tab" data-tab="my-posts" onclick="switchForumTab('my-posts')" style="padding: 0.75rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; color: var(--text-secondary); font-weight: 500; white-space: nowrap; margin-bottom: -2px;">
                            Mis Posts
                        </button>
                        <button class="forum-tab" data-tab="my-reports" onclick="switchForumTab('my-reports')" style="padding: 0.75rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; color: var(--text-secondary); font-weight: 500; white-space: nowrap; margin-bottom: -2px;">
                            Mis Reportes
                        </button>
                        <button class="forum-tab" data-tab="notifications" onclick="switchForumTab('notifications')" style="padding: 0.75rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; color: var(--text-secondary); font-weight: 500; white-space: nowrap; margin-bottom: -2px; position: relative;">
                            Notificaciones
                            <span id="notificationsBadge" style="display: none; position: absolute; top: 0.5rem; right: 0.5rem; background: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: bold; text-align: center; line-height: 18px;"></span>
                        </button>
                    <% } %>
                </div>

                <!-- Tab Content: All Posts -->
                <div id="allPostsTab" class="forum-tab-content" style="display: block;">
                    <!-- Filter/Sort Options -->
                <div class="forum-controls" style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button id="sortRecent" class="sort-btn active" data-sort="recent">游 Recientes</button>
                        <button id="sortPopular" class="sort-btn" data-sort="popular">游댠 Populares</button>
                    </div>
                    <div style="flex: 1; min-width: 200px;"></div>
                    <div id="hashtagFilters" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                        <span style="font-size: 0.85rem; color: var(--text-secondary);">Filtrar por:</span>
                        <button class="hashtag-filter-btn" onclick="clearHashtagFilter()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                            Todos
                        </button>
                    </div>
                </div>

                <script>
                    // Load hashtag filters dynamically
                    fetch('/forum/hashtags')
                        .then(res => res.json())
                        .then(data => {
                            const container = document.getElementById('hashtagFilters');
                            if (data.hashtags && data.hashtags.length > 0) {
                                data.hashtags.slice(0, 8).forEach(tag => {
                                    const btn = document.createElement('button');
                                    btn.className = 'hashtag-filter-btn';
                                    btn.dataset.hashtag = tag;
                                    btn.textContent = `#${tag}`;
                                    btn.onclick = () => filterByHashtag(tag);
                                    container.appendChild(btn);
                                });
                            }
                        })
                        .catch(err => console.error('Error loading hashtag filters:', err));
                </script>

                <!-- Threads List -->
                <div id="threadsList">
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        Cargando threads...
                    </div>
                </div>

                <!-- Pagination -->
                <div id="pagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;"></div>
                </div>

                <!-- Tab Content: My Posts -->
                <% if (isAuthenticated) { %>
                <div id="myPostsTab" class="forum-tab-content" style="display: none;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; align-items: center;">
                        <button id="myPostsSortRecent" class="sort-btn active" data-sort="recent">游 Recientes</button>
                        <button id="myPostsSortPopular" class="sort-btn" data-sort="popular">游댠 Populares</button>
                    </div>
                    <div id="myThreadsList">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            Cargando tus posts...
                        </div>
                    </div>
                    <div id="myThreadsPagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;"></div>
                </div>

                <!-- Tab Content: My Reports -->
                <div id="myReportsTab" class="forum-tab-content" style="display: none;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; align-items: center; flex-wrap: wrap;">
                        <span style="font-size: 0.875rem; color: var(--text-secondary);">Filtrar:</span>
                        <button class="hashtag-filter-btn" onclick="filterMyReports('')">Todos</button>
                        <button class="hashtag-filter-btn" onclick="filterMyReports('pending')">Pendientes</button>
                        <button class="hashtag-filter-btn" onclick="filterMyReports('reviewed')">Revisados</button>
                        <button class="hashtag-filter-btn" onclick="filterMyReports('resolved')">Resueltos</button>
                        <button class="hashtag-filter-btn" onclick="filterMyReports('rejected')">Rechazados</button>
                    </div>
                    <div id="myReportsList">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            Cargando tus reportes...
                        </div>
                    </div>
                    <div id="myReportsPagination" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;"></div>
                </div>

                <!-- Tab Content: Notifications -->
                <div id="notificationsTab" class="forum-tab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">Tus Notificaciones</h3>
                        <button onclick="markAllNotificationsAsRead()" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            Marcar todas como le칤das
                        </button>
                    </div>
                    <div id="notificationsList">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            Cargando notificaciones...
                        </div>
                    </div>
                </div>
                <% } %>

            </div>
        </div>
    </div>

    <!-- Welcome Modal (shown only first time) -->
    <div id="welcomeForumModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: flex-start;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <h2 style="margin: 0;">Bienvenido al Foro Austra</h2>
                </div>
                <button class="modal-close" onclick="closeWelcomeForumModal()">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 1.6;">
                    El Foro Austra es un espacio de discusi칩n comunitaria para todos los temas relacionados con Austra: seguridad ciudadana (Centinel), inmuebles y autos (Surlink), y m치s. Comparte experiencias, haz preguntas y participa en debates constructivos.
                </p>

                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Caracter칤sticas del Foro</h3>
                <ul style="margin-bottom: 1.5rem; line-height: 1.8; color: var(--text-secondary);">
                    <li><strong>Threads de discusi칩n:</strong> Crea temas sobre Centinel, Surlink, o cualquier servicio de Austra</li>
                    <li><strong>Comentarios anidados:</strong> Responde a otros usuarios (hasta 5 niveles)</li>
                    <li><strong>Editor de texto enriquecido:</strong> Formato, enlaces, listas y m치s</li>
                    <li><strong>Im치genes:</strong> Sube hasta 5 im치genes por publicaci칩n</li>
                    <li><strong>Sistema de likes:</strong> Valora el contenido de la comunidad</li>
                    <li><strong>Editar/Eliminar:</strong> Modifica tu contenido durante los primeros 5 minutos</li>
                </ul>

                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">L칤mites de Publicaci칩n</h3>
                <ul style="margin-bottom: 1.5rem; line-height: 1.8; color: var(--text-secondary);">
                    <li><strong>Threads:</strong> Uno cada 30 minutos</li>
                    <li><strong>Comentarios:</strong> M치ximo 100 por d칤a</li>
                    <li><strong>Im치genes:</strong> M치ximo 5 por publicaci칩n (JPG, PNG, WEBP)</li>
                </ul>

                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; text-align: center;">
                    <h3 style="margin-bottom: 0.75rem; color: #ef4444; font-size: 1rem;">丘멆잺 Normas de Conducta</h3>
                    <p style="margin-bottom: 0.75rem; color: var(--text-secondary); line-height: 1.6; font-size: 0.9rem;">
                        <strong>El administrador se reserva el derecho de eliminar cualquier contenido, suspender o banear permanentemente a cualquier usuario que no respete las normas del foro, sin previo aviso.</strong>
                    </p>
                    <ul style="line-height: 1.6; color: var(--text-secondary); font-size: 0.9rem; list-style-position: inside; text-align: center; margin: 0 auto;">
                        <li>Trata a otros usuarios con respeto</li>
                        <li>No publiques contenido ofensivo, ilegal o spam</li>
                        <li>Mant칠n las discusiones relevantes a los servicios de Austra</li>
                        <li>No difundas informaci칩n falsa o rumores</li>
                        <li>Respeta los l칤mites de publicaci칩n establecidos</li>
                    </ul>
                </div>

                <div style="text-align: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        Al usar el foro, aceptas nuestros <a href="/terms" target="_blank" style="color: var(--primary-color);">T칠rminos de Servicio</a> y <a href="/privacy" target="_blank" style="color: var(--primary-color);">Pol칤tica de Privacidad</a>.
                    </p>
                    <button class="btn btn-primary" onclick="closeWelcomeForumModal()" style="width: 100%;">
                        Entendido, comenzar a participar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Thread Modal -->
    <div id="newThreadModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Crear Nuevo Thread</h2>
                <button class="modal-close" onclick="closeNewThreadModal()">&times;</button>
            </div>
            <form id="newThreadForm" enctype="multipart/form-data">
                <!-- Thread Type Selector -->
                <div class="thread-type-selector">
                    <div class="thread-type-option">
                        <input type="radio" id="typeDiscussion" name="threadType" value="discussion" checked>
                        <label for="typeDiscussion">游눫 Discusi칩n</label>
                    </div>
                    <div class="thread-type-option">
                        <input type="radio" id="typePoll" name="threadType" value="poll">
                        <label for="typePoll">游늵 Encuesta/Votaci칩n</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="threadTitle">T칤tulo *</label>
                    <input type="text" id="threadTitle" name="title" maxlength="200" required placeholder="T칤tulo del thread...">
                    <small><span id="titleCharCount">0</span>/200</small>
                </div>

                <div class="form-group">
                    <label for="threadHashtags">Hashtags * (selecciona al menos 1, m치ximo 5)</label>
                    <div id="hashtagsContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; background: var(--surface); border: 1px solid var(--border-color); border-radius: 4px; min-height: 60px;">
                        <small style="width: 100%; color: var(--text-secondary);">Cargando hashtags...</small>
                    </div>
                    <input type="hidden" id="threadHashtags" name="hashtags" required>
                </div>

                <!-- Poll Creation Section -->
                <div id="pollCreationSection">
                    <h4>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="16" rx="2"></rect>
                            <path d="M7 10h4M7 14h8M17 10v4"></path>
                        </svg>
                        Configurar Encuesta
                    </h4>

                    <div id="pollOptionsContainer"></div>

                    <button type="button" id="addPollOptionBtn" onclick="addPollOption()">
                        + Agregar opci칩n
                    </button>

                    <div class="poll-settings">
                        <div class="poll-setting-item">
                            <label for="pollExpiresAt">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                Fecha de expiraci칩n (opcional):
                            </label>
                            <input type="datetime-local" id="pollExpiresAt" name="pollExpiresAt">
                        </div>

                        <div class="poll-setting-item">
                            <input type="checkbox" id="pollAllowMultiple" name="pollAllowMultiple">
                            <label for="pollAllowMultiple">Permitir selecci칩n m칰ltiple</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="threadContent">Contenido * <small style="color: var(--text-secondary); font-weight: normal;">(Puedes mencionar usuarios con @nombre)</small></label>
                    <div id="threadContentEditor" style="min-height: 250px; background: var(--surface); border: 1px solid var(--border-color); border-radius: 4px;"></div>
                    <input type="hidden" id="threadContent" name="content" required>
                    <small><span id="contentCharCount">0</span>/10000 caracteres</small>
                </div>

                <div class="form-group">
                    <label for="threadImages">Im치genes (opcional - m치ximo 5)</label>
                    <input type="file" id="threadImages" name="images" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                        Formatos: JPG, PNG, WEBP. M치ximo 5MB por imagen.
                    </small>
                    <div id="imagePreview" style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;"></div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Publicar Thread</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNewThreadModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Perfil de Usuario</h2>
                <button class="modal-close" onclick="closeUserProfileModal()">&times;</button>
            </div>
            <div id="userProfileContent">
                <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Cargando...</p>
            </div>
        </div>
    </div>

    <script src="/js/forum-user-profile.js"></script>
    <script src="/js/forum-tabs.js"></script>
    <%- include('partials/footer') %>
</body>
</html>
